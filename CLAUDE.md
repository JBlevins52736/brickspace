# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

> **Note**: This documentation was generated by Claude Code to assist with repository migration and documentation polishing. The actual BrickSpace architecture and implementation were designed and developed by the Full Sail VR/AR Labs team.

## Project Overview

BrickSpace is an Unreal Engine VR application for building with LEGO-style bricks in virtual reality. It's designed for Oculus/Meta Quest devices with hand tracking and supports multiplayer colocation using OculusXR. The project enables collaborative building experiences where users can construct assemblies layer-by-layer following predefined models (like rockets).

## Building and Running

This is an Unreal Engine C++ project targeting UE 5.x.

- **Project File**: `BrickSpace.uproject`
- **Engine Association**: Custom engine build (see EngineAssociation in .uproject)
- **Target Platforms**: Windows (Win64) and Android (Quest)

To open the project:
```bash
# Open with Unreal Editor (double-click BrickSpace.uproject or use Unreal Engine Launcher)
```

To build from command line (Windows):
```bash
# Build the project (requires Unreal Engine installed)
"C:\Program Files\Epic Games\UE_5.x\Engine\Build\BatchFiles\Build.bat" BrickSpaceEditor Win64 Development -Project="C:\Users\jasen\Desktop\Brickspace\brickspace\BrickSpace.uproject"
```

To clean build artifacts:
```bash
Cleanup.bat
```

## Architecture

### Core Systems

**Vodget/Selector Pattern** - Custom VR interaction system:
- `UVodget`: Base class for all interactive 3D UI elements in VR space. Responds to hand tracking gestures (Focus, ForePinch, MiddlePinch, Grip)
- `USelector`: Maintains a 3D cursor from hand tracking and routes gestures to focused Vodgets
- Uses selection filters (bitmasks) to enable/disable different interaction modes
- All interactive components inherit from Vodget (Grabber, Brick, MenuItem, SliderButton, etc.)

**Brick System**:
- `UBrick`: Core component for LEGO-style bricks with snap-to-grid physics using studs and tubes
- `UStud` and `UTube`: Snap points with 0.78cm spacing (studs) and 0.32cm Z-offset (tubes)
- `UGrabber`: Base class enabling VR grabbing/dragging of objects
- Bricks support replication with properties like `isSolid`, `brickMaterial`, and `isGrabbable`
- Overlap detection finds nearby bricks and automatically snaps compatible studs/tubes

**Assembly System** (`UAssembly`):
- Loads predefined build instructions from JSON files (Config/Rocket.json, Rocket2Layers.json)
- Manages layer-by-layer progression through `LoadNextLayer()` and `TryAdvanceLayer()`
- Players place bricks matching revealed template bricks
- `TryMatch()` validates brick placement (position, rotation, material color)
- Uses Material Data Tables to map between solid and "reveal" (transparent) materials
- Supports launching completed assemblies (e.g., rocket launch with Niagara particle effects)

**Networking**:
- `ABrickSpacePawn`: Main player pawn with Server RPCs for all replicated actions
  - Material changes, object movement, deletion, cloning, assembly progression
  - All gameplay mutations go through Server_* RPC methods
- `ABrickSpaceGameState`: Manages replicated world state (world-to-meters scale)
- `ABrickSpacePlayerState`: Per-player state (used for player color, team info)
- `AAssemblyActor`: Actor wrapper for Assembly component with replication support

**Colocation** (`UColocationSetup`):
- OculusXR colocation utilities for multiplayer spatial alignment
- IP-based session joining for Quest devices sharing physical space
- Enables multiple users to see same virtual objects aligned to real world

**Calibration System**:
- `UCalib2Pt`: Two-point calibration for world alignment
- `UCalib2Hands`: Two-handed calibration using both controllers
- `UAlignWorld`: Utilities for coordinate system alignment
- Calibration data stored in Config/Calibration.json

### Key Components

- **UBrickEreaser**: Deletes bricks in VR
- **UPaintbrush**: Changes brick materials/colors
- **URevealWand**: Toggles between solid and reveal materials for assembly hints
- **UHandSelector/UHandColorChanger**: Hand tracking UI for selecting colors/modes
- **UMenuItem/USliderButton**: VR UI widgets built on Vodget system
- **UFeedBackLog**: In-world text display for user feedback
- **UAnchor**: Spatial anchor management for persistent placement

### Module Dependencies

From `BrickSpace.Build.cs`:
- Core Unreal modules: Core, CoreUObject, Engine, InputCore, UMG
- VR/XR: OculusXRScene, OculusXRHMD, OculusXRAnchors, OculusXRColocation, OculusXRInput, HeadMountedDisplay, OpenXR
- Niagara for particle effects
- Networking: Sockets, OnlineSubsystem
- JSON serialization: Json, JsonUtilities
- Android permissions for Quest builds

### Plugins

- **Jacobs_VFX**: Custom visual effects plugin (content-only)
- **ReplicationTest**: Network replication debugging plugin with C++ source

### Content Structure

- **Content/BluePrint**: Blueprint assets
- **Content/Models**: LEGO brick 3D models
- **Content/Materials**: Material definitions and MaterialData data table
- **Content/Maps**: Level files
- **Content/HandTracking**: Hand tracking configuration
- **Content/Oculus**: OculusXR-specific assets
- **Content/Vefects**: Visual effects (Niagara)
- **Content/Input**: Enhanced Input mappings
- **BP_BrickworldPawn**: Main VR pawn blueprint
- **BP_BrickworldGameMode**: Game mode configuration

## Working with C++ Code

### Adding New Bricks or Vodgets

When creating new interactive components:
1. Inherit from `UVodget` (for non-grabable UI) or `UGrabber` (for grabable objects) or `UBrick` (for snap-enabled bricks)
2. Override gesture methods: `Focus()`, `ForePinch()`, `MiddlePinch()`, `Grip()`
3. Set appropriate `selectionFilter` bitmask for interaction filtering
4. For networked objects, add replication to properties and create Server_* RPCs in `ABrickSpacePawn`

### Network Replication Pattern

All mutable actions follow this pattern:
1. Client calls `Server_SomeAction()` on their pawn
2. Server validates and executes on authoritative object
3. Server updates replicated properties (marked with `Replicated` or `ReplicatedUsing`)
4. `OnRep_*` functions fire on all clients to update local state

### Assembly JSON Format

JSON files in Config/ define build sequences:
```json
{
  "bricks": [
    {
      "layerInd": 0,
      "shortName": "2x4_Brick",
      "position": [x, y, z],
      "rotation": [qx, qy, qz, qw],
      "material": "MaterialName"
    }
  ]
}
```

Materials must exist in MaterialData data table.

## Common Workflows

### Testing VR Features

This project requires VR hardware (Meta Quest with hand tracking) for full testing. Desktop testing is limited.

### Adding New Assemblies

1. Create JSON file in Config/ following the assembly format
2. Add filename to `UAssembly::JSONTable` in Blueprint or C++
3. Reference appropriate brick `shortName` values from BrickData table
4. Use material names from MaterialData table

### Modifying Snap Behavior

Snap logic lives in `UBrick`:
- `FindSnaps()`: Detects nearby snap candidates from overlapped bricks
- `SolveSnaps()`: Applies snap transforms
- `TryBreakSnaps()`: Releases snaps when grabbed
- Adjust snap distances or filtering in these methods

### Debugging Networking

Use ReplicationTest plugin and check:
- `ABrickSpacePawn::VARLog()` for logging to FeedBackLog in VR
- Unreal's network profiler for replication debugging
- PIE with multiple clients for local multiplayer testing
